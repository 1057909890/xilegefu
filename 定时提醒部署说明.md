# 定时提醒功能部署说明

## 📍 功能说明

实现了每天3次定时提醒功能，提醒时间点为：
- **早上 08:00**
- **中午 12:00**
- **晚上 20:00**

## 📁 文件位置

### 1. 云函数
- `cloudfunctions/sendReminder/index.js` - 定时提醒云函数主逻辑
- `cloudfunctions/sendReminder/config.json` - 云函数配置（包含定时触发器）
- `cloudfunctions/sendReminder/package.json` - 依赖配置

### 2. 前端代码
- `miniprogram/pages/home/index.js` - 订阅消息保存逻辑（第334-380行）

## 🚀 部署步骤

### 第一步：创建数据库集合

在云开发控制台创建 `subscribe_settings` 集合，字段如下：

```javascript
{
  _id: "自动生成",
  openid: "用户openid",
  enabled: true,              // 是否开启提醒
  plan: "deep",               // 计划类型：light/morning/deep/beginner/advanced
  type: "daily",              // 类型：daily/weekly
  times: 3,                   // 提醒次数
  subscribeResult: {},        // 订阅消息授权结果
  createTime: Date,           // 创建时间
  updateTime: Date            // 更新时间
}
```

**权限设置**：仅创建者可读写

### 第二步：配置订阅消息模板

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序后台 → **功能** → **订阅消息**
3. 申请订阅消息模板，建议包含以下字段：
   - `thing1` - 训练名称（如：腹式呼吸训练）
   - `time2` - 提醒时间（如：08:00）
   - `thing3` - 提示内容（如：开始今天的训练吧！）
4. 获取模板ID，替换以下位置的模板ID：
   - `cloudfunctions/sendReminder/index.js` 第60行
   - `miniprogram/pages/home/index.js` 第338行

### 第三步：修改云函数配置

打开 `cloudfunctions/sendReminder/config.json`，确认定时触发器配置：

```json
{
  "triggers": [
    {
      "name": "dailyReminder",
      "type": "timer",
      "config": "0 0 8,12,20 * * * *"
    }
  ]
}
```

**Cron 表达式说明**：`0 0 8,12,20 * * * *`
- 每天 08:00、12:00、20:00 执行
- 格式：`秒 分 时 日 月 星期 年`

### 第四步：部署云函数

**方法一：通过云开发面板部署（推荐）**

1. 在微信开发者工具中，点击顶部工具栏的 **"云开发"** 按钮
2. 打开云开发控制台
3. 点击左侧菜单 **"云函数"**
4. 在云函数列表中，找到 `sendReminder`（如果不存在，需要先上传）
5. 点击 `sendReminder` 右侧的 **"上传并部署"** 按钮
6. 选择 **"云端安装依赖"**
7. 等待部署完成

**方法二：通过文件资源管理器（如果支持）**

1. 在微信开发者工具的文件资源管理器中
2. 找到 `cloudfunctions/sendReminder` 文件夹
3. 右键点击该文件夹
4. 如果看到 **"上传并部署：云端安装依赖"** 选项，点击它
5. 等待部署完成

**注意**：如果右键菜单中没有此选项，请使用方法一。

### 第五步：测试

1. 在小程序中开启订阅计划（选择"深度冥想" - 每天3次）
2. 授权订阅消息
3. 等待定时触发器执行（或手动触发云函数测试）

## ⚙️ 修改提醒时间点

如果需要修改提醒时间，编辑 `cloudfunctions/sendReminder/index.js`：

```javascript
// 提醒时间点配置（每天3次）
const REMINDER_TIMES = [
  { hour: 8, minute: 0, name: '早上' },   // 修改这里
  { hour: 12, minute: 0, name: '中午' },  // 修改这里
  { hour: 20, minute: 0, name: '晚上' }   // 修改这里
]
```

同时需要修改 `config.json` 中的 cron 表达式：

```json
{
  "config": "0 0 8,12,20 * * * *"  // 修改小时数
}
```

## 📝 注意事项

1. **订阅消息模板字段**：需要根据实际申请的模板字段调整 `messageData` 中的字段名
2. **模板ID**：确保所有位置的模板ID一致
3. **权限配置**：确保云函数有 `subscribeMessage.send` 权限
4. **用户授权**：只有用户授权了订阅消息，才会收到提醒
5. **定时触发器**：部署后需要等待几分钟才能生效

## 🔍 调试

### 查看云函数日志
1. 在微信开发者工具中，打开 **云开发** → **云函数** → **sendReminder**
2. 查看 **日志** 标签页

### 手动触发测试
可以在云函数中添加测试代码，或通过云开发控制台手动触发。

## 📚 相关文档

- [微信小程序订阅消息文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
- [云函数定时触发器文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
