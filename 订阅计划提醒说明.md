# 订阅计划提醒说明

## 📋 不同计划的提醒时间配置

### 每日计划（Daily）

#### 1. 轻量练习（每天1次）
- **提醒时间**：每天 20:00
- **计划类型**：`type: 'daily'`, `times: 1`
- **提醒内容**：今天的训练时间到了，开始练习吧！

#### 2. 早晚调息（每天2次）
- **提醒时间**：每天 08:00 和 20:00
- **计划类型**：`type: 'daily'`, `times: 2`
- **提醒内容**：
  - 08:00：早上好，开始今天的第一次练习吧！
  - 20:00：晚上好，完成今天的第二次练习吧！

#### 3. 深度冥想（每天3次）
- **提醒时间**：每天 10:00、14:00、20:00
- **计划类型**：`type: 'daily'`, `times: 3`
- **提醒内容**：今日计划还未完成哦,请及时完成!

### 每周计划（Weekly）

#### 4. 初试身手（每周3次）
- **提醒时间**：周一、周三、周五 20:00
- **计划类型**：`type: 'weekly'`, `times: 3`
- **提醒内容**：本周的训练时间到了，开始练习吧！

#### 5. 进阶挑战（每周5次）
- **提醒时间**：周一到周五 20:00
- **计划类型**：`type: 'weekly'`, `times: 5`
- **提醒内容**：今天的训练时间到了，保持节奏！

## ⚙️ 云函数配置

### 定时触发器

定时触发器配置在 `cloudfunctions/sendReminder/config.json`：

```json
{
  "triggers": [
    {
      "name": "dailyReminder",
      "type": "timer",
      "config": "0 0 8,10,14,20 * * * *"
    }
  ]
}
```

**Cron 表达式说明**：`0 0 8,10,14,20 * * * *`
- 每天在 08:00、10:00、14:00、20:00 执行
- 格式：`秒 分 时 日 月 星期 年`

### 提醒逻辑

云函数 `sendReminder` 会：

1. **查询所有开启订阅的用户**
   - 从 `subscribe_settings` 集合查询 `enabled: true` 的记录

2. **根据计划类型匹配提醒时间**
   - **每日计划**：检查当前时间是否匹配该计划的提醒时间点
   - **每周计划**：检查当前时间是否匹配，并且当前是星期几

3. **发送订阅消息**
   - 只发送给已授权订阅消息的用户
   - 根据不同的计划类型生成不同的提醒内容

## 📊 提醒时间点汇总

| 计划 | 类型 | 次数 | 提醒时间点 |
|------|------|------|-----------|
| 轻量练习 | daily | 1 | 20:00 |
| 早晚调息 | daily | 2 | 08:00, 20:00 |
| 深度冥想 | daily | 3 | 10:00, 14:00, 20:00 |
| 初试身手 | weekly | 3 | 周一、周三、周五 20:00 |
| 进阶挑战 | weekly | 5 | 周一到周五 20:00 |

## 🔍 代码位置

### 提醒时间配置
- 文件：`cloudfunctions/sendReminder/index.js`
- 位置：第 8-33 行（`REMINDER_TIMES` 对象）

### 提醒逻辑
- 文件：`cloudfunctions/sendReminder/index.js`
- 位置：第 68-218 行（`exports.main` 函数）

### 前端订阅设置
- 文件：`miniprogram/pages/home/index.js`
- 位置：第 381-395 行（`planMap` 和订阅设置保存）

## 🧪 测试方法

### 测试不同计划

1. **测试每天1次**
   - 选择"轻量练习"计划
   - 等待 20:00 或手动触发云函数

2. **测试每天2次**
   - 选择"早晚调息"计划
   - 等待 08:00 或 20:00

3. **测试每天3次**
   - 选择"深度冥想"计划
   - 等待 10:00、14:00 或 20:00

4. **测试每周3次**
   - 选择"初试身手"计划
   - 在周一、周三或周五的 20:00 测试

5. **测试每周5次**
   - 选择"进阶挑战"计划
   - 在周一到周五的 20:00 测试

### 手动触发测试

修改云函数代码，临时注释掉时间检查，测试所有计划：

```javascript
// 临时测试：注释掉时间检查
// 在 exports.main 函数中，可以临时设置：
const currentHour = 20  // 测试20:00
const currentMinute = 0
const currentWeekday = 1  // 测试周一
```

## 📝 注意事项

1. **定时触发器执行时间**
   - 云函数在 08:00、10:00、14:00、20:00 执行
   - 每次执行时，会检查所有用户的计划类型，匹配的才发送

2. **每周计划的星期判断**
   - JavaScript 的 `getDay()` 返回 0-6（0=周日，1=周一）
   - 代码中已处理转换，确保配置的星期几正确匹配

3. **用户授权检查**
   - 只有用户授权了订阅消息才会发送
   - 检查 `subscribeResult[templateId]` 是否存在

4. **时间误差**
   - 允许 5 分钟误差（±5分钟）
   - 例如：20:00-20:05 之间都会匹配 20:00 的提醒

## 🔄 修改提醒时间

如果需要修改提醒时间，编辑 `cloudfunctions/sendReminder/index.js` 中的 `REMINDER_TIMES` 对象：

```javascript
const REMINDER_TIMES = {
  daily_1: [
    { hour: 20, minute: 0, name: '晚上' }  // 修改这里
  ],
  // ... 其他计划
}
```

同时需要更新 `config.json` 中的 cron 表达式，包含所有需要执行的时间点。
