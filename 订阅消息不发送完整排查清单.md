# 订阅消息不发送完整排查清单

## 🔍 问题现象

手动触发测试可以成功，有日志，但定时触发器不执行，没有收到微信提醒。

## 📋 完整排查步骤

### ✅ 1. 云函数安全规则（最重要！）

**问题**：定时触发器执行时没有 `auth`，如果安全规则要求 `auth != null`，定时触发器无法执行。

**检查方法**：
1. 云开发控制台 → 云函数 → **自定义安全规则**
2. 查看当前规则

**解决方法**：
```json
{
  "*": {
    "invoke": true
  }
}
```
或只为 `sendReminder` 设置：
```json
{
  "sendReminder": {
    "invoke": true
  },
  "*": {
    "invoke": "auth != null"
  }
}
```

**验证**：修改后等待 1-3 分钟，查看云函数日志是否有执行记录。

---

### ✅ 2. 定时触发器状态和配置

**检查项**：
- [ ] 触发器状态是否为 **已启用**
- [ ] Cron 表达式是否正确：`0 * * * * *`（每分钟执行）
- [ ] 触发器是否已部署

**检查方法**：
1. 云开发控制台 → 云函数 → `sendReminder` → **触发器** 标签页
2. 查看触发器状态和配置

**解决方法**：
- 如果被禁用，点击 **启用**
- 如果配置错误，修改 `config.json` 后重新部署
- 重新部署后等待 5-10 分钟让触发器生效

---

### ✅ 3. 时区问题

**问题**：云函数执行环境的时区可能是 UTC+0，而定时触发器按 UTC+8（北京时间）执行，导致时间不匹配。

**检查方法**：
在云函数日志中查看执行时间，对比：
- 定时触发器触发时间（UTC+8）
- 云函数内部 `new Date()` 获取的时间

**解决方法**：
在云函数代码开头添加：
```javascript
// 设置时区为北京时间
process.env.TZ = 'Asia/Shanghai'
```

或者在云函数环境变量中设置 `TZ=Asia/Shanghai`。

---

### ✅ 4. 订阅消息授权状态

**检查项**：
- [ ] 用户是否授权了订阅消息
- [ ] 授权状态是否为 `"accept"`
- [ ] 授权是否过期（订阅消息授权有时效性）

**检查方法**：
1. 云开发控制台 → 数据库 → `subscribe_settings`
2. 查看 `subscribeResult` 字段：
   ```javascript
   {
     "YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ": "accept"  // 必须是 "accept"
   }
   ```

**解决方法**：
- 如果状态不是 `"accept"`，在小程序中重新授权
- 订阅消息授权后只能发送一次，需要重新授权才能再次发送

---

### ✅ 5. 小程序版本问题（体验版 vs 正式版）

**问题**：小程序未发版（只有体验版）可能影响订阅消息发送。

**检查方法**：
1. 微信公众平台 → 小程序后台 → **版本管理**
2. 查看当前版本状态

**解决方法**：
- 云函数代码已优化，会依次尝试 `trial`（体验版）、`formal`（正式版）、`developer`（开发版）
- 如果仍然失败，尝试发布小程序为正式版

---

### ✅ 6. 数据库查询条件

**检查项**：
- [ ] `enabled` 字段是否为 `true`
- [ ] `reminderTimes` 数组不为空
- [ ] 时间格式正确：`[{"hour": 20, "minute": 7}]`

**检查方法**：
1. 云开发控制台 → 数据库 → `subscribe_settings`
2. 查看记录的所有字段

**解决方法**：
- 确保 `enabled: true`
- 确保 `reminderTimes` 格式正确
- 确保时间在合理范围内（0-23 小时，0-59 分钟）

---

### ✅ 7. 时间匹配逻辑

**检查项**：
- [ ] 当前时间是否在提醒时间的误差范围内（允许3分钟误差）
- [ ] 时间匹配逻辑是否正确

**检查方法**：
查看云函数日志中的时间比较：
```
[定时提醒] 比较时间: 当前 20:08 vs 目标 20:07
[定时提醒] ✅ 时间匹配成功
```

**解决方法**：
- 如果时间不匹配，检查时间匹配逻辑
- 确认误差范围是否足够（当前为3分钟）

---

### ✅ 8. 订阅消息模板配置

**检查项**：
- [ ] 模板ID是否正确
- [ ] 模板是否已审核通过
- [ ] 模板字段是否匹配

**检查方法**：
1. 微信公众平台 → 小程序后台 → **功能** → **订阅消息**
2. 查看模板状态和字段

**解决方法**：
- 确保模板已审核通过
- 确保模板ID与代码中的一致
- 确保消息数据字段与模板字段匹配

---

### ✅ 9. 云函数权限配置

**检查项**：
- [ ] 云函数是否有 `openapi.subscribeMessage.send` 权限

**检查方法**：
1. 云开发控制台 → 云函数 → `sendReminder` → **权限设置**
2. 查看权限列表

**解决方法**：
- 在 `config.json` 中确认有权限配置：
  ```json
  {
    "permissions": {
      "openapi": [
        "subscribeMessage.send"
      ]
    }
  }
  ```
- 重新部署云函数

---

### ✅ 10. 云函数日志分析

**检查方法**：
1. 云开发控制台 → 云函数 → `sendReminder` → **日志**
2. 查看是否有执行记录
3. 查看日志中的错误信息

**关键日志**：
- `[定时提醒] ========== 定时触发器执行 ==========` - 触发器已执行
- `[定时提醒] 查询到 X 个开启订阅的用户` - 查询成功
- `[定时提醒] ✅ 时间匹配成功` - 时间匹配
- `[发送消息] ✅ 成功发送` - 消息发送成功
- `[定时提醒] ⚠️ 用户未授权订阅消息` - 授权问题
- `[发送消息] ❌ 发送失败` - 发送失败

**解决方法**：
根据日志中的错误信息，对应上述检查项进行修复。

---

## 🛠️ 快速修复步骤

如果以上检查都正常，按以下步骤操作：

1. **修改云函数安全规则**（最重要）
   ```json
   {
     "*": {
       "invoke": true
     }
   }
   ```

2. **重新部署云函数**
   - 云开发控制台 → 云函数 → `sendReminder` → **上传并部署**

3. **等待触发器生效**
   - 等待 5-10 分钟

4. **手动触发测试**
   - 云开发控制台 → 云函数 → `sendReminder` → **测试**
   - 输入：`{}`
   - 查看返回结果和日志

5. **查看定时触发器执行记录**
   - 等待定时触发器执行
   - 查看日志确认是否有执行记录

---

## 📝 常见错误码

| 错误码 | 说明 | 解决方法 |
|--------|------|----------|
| 40037 | 模板ID错误 | 检查模板ID是否正确 |
| 47001 | miniprogram_state 错误 | 检查小程序版本，使用正确的 state |
| 43101 | 用户拒绝授权 | 用户需要重新授权 |
| 40001 | 参数错误 | 检查消息数据格式 |
| -501000 | 环境未找到 | 检查云开发环境配置 |

---

## 🔗 相关文档

- [云函数安全规则文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/security-rules.html)
- [定时触发器文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
- [订阅消息文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
