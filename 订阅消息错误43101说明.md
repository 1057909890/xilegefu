# 订阅消息错误 43101 说明

## 🔍 错误信息

```
errCode: 43101
errMsg: openapi.subscribeMessage.send:fail user refuse to accept the msg
```

**含义**：用户拒绝接受订阅消息

## 📋 错误原因

### 1. **用户拒绝了订阅授权**

当用户在小程序中点击"保存设置"时，会弹出订阅消息授权弹窗。如果用户点击了**"拒绝"**或**"取消"**，授权状态会变成 `"reject"` 或 `"ban"`，而不是 `"accept"`。

### 2. **订阅消息授权已过期**

微信订阅消息授权有时效性：
- 用户授权后，**每个模板ID只能发送一次消息**
- 如果已经发送过一次，需要用户**重新授权**才能再次发送
- 授权状态可能会从 `"accept"` 变为 `"reject"` 或 `"ban"`

### 3. **用户主动关闭了订阅消息**

用户可能在微信设置中关闭了小程序的订阅消息权限。

## ✅ 解决方法

### 方法1：重新授权订阅消息（推荐）

1. **在小程序中重新打开订阅设置**
   - 点击首页的铃铛图标
   - 打开提醒设置弹窗

2. **重新保存设置**
   - 点击"保存设置"按钮
   - 会再次弹出订阅消息授权弹窗

3. **用户必须点击"允许"**
   - 确保用户点击**"允许"**而不是"拒绝"
   - 授权成功后，数据库中的 `subscribeResult` 会更新为 `"accept"`

### 方法2：检查数据库中的授权状态

1. **查看数据库记录**
   - 云开发控制台 → 数据库 → `subscribe_settings`
   - 查看 `subscribeResult` 字段

2. **确认授权状态**
   ```javascript
   {
     "subscribeResult": {
       "YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ": "accept"  // 必须是 "accept"
     }
   }
   ```

3. **如果状态不是 "accept"**
   - 需要用户重新授权
   - 或者手动在数据库中删除该记录，让用户重新订阅

### 方法3：优化用户体验

在代码中添加更友好的提示：

1. **保存设置时检查授权状态**
   - 如果用户拒绝了授权，提示用户需要允许才能收到提醒

2. **发送失败时更新数据库**
   - 如果收到 43101 错误，更新数据库中的授权状态
   - 下次提醒时跳过该用户，避免重复尝试

## 🔧 代码优化建议

### 1. 在发送失败时更新授权状态

```javascript
// 如果收到 43101 错误，更新数据库中的授权状态
if (err.errCode === 43101) {
  // 更新数据库，标记用户已拒绝
  await db.collection('subscribe_settings')
    .doc(setting._id)
    .update({
      data: {
        'subscribeResult.YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ': 'reject',
        updateTime: db.serverDate()
      }
    })
  console.log(`[定时提醒] 用户 ${userOpenid} 已拒绝订阅消息，已更新数据库`)
}
```

### 2. 在查询时过滤已拒绝的用户

```javascript
// 只查询授权状态为 "accept" 的用户
const allSubscribeSettings = await db.collection('subscribe_settings')
  .where({
    enabled: true,
    'subscribeResult.YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ': 'accept'
  })
  .get()
```

## 📝 常见问题

### Q1: 为什么用户授权了还是收到 43101？

**A**: 可能的原因：
1. 授权后已经发送过一次消息，需要重新授权
2. 用户在微信设置中关闭了订阅消息
3. 授权状态在数据库中未正确保存

### Q2: 如何避免 43101 错误？

**A**: 
1. 在发送前检查授权状态
2. 发送失败后更新数据库状态
3. 定期提醒用户重新授权（如果授权过期）

### Q3: 43101 错误会影响其他功能吗？

**A**: 不会。这只是订阅消息发送失败，不影响小程序的其他功能。

## 🔗 相关文档

- [微信订阅消息文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
- [订阅消息错误码说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
