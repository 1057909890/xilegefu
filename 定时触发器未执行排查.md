# 定时触发器未执行排查指南

## 🔍 问题现象

时间已经 20:08，数据库中设置了 20:07 的提醒，但是：
- 云函数没有执行
- 没有收到微信提醒

## 📋 排查步骤

### 1. 检查定时触发器状态

1. 在微信开发者工具中，点击顶部工具栏的 **"云开发"** 按钮
2. 打开云开发控制台
3. 点击左侧菜单 **"云函数"**
4. 找到 `sendReminder` 云函数
5. 查看 **"触发器"** 标签页
6. 确认定时触发器状态：
   - ✅ **已启用** - 触发器正常工作
   - ❌ **已禁用** - 需要启用触发器
   - ⚠️ **异常** - 需要检查配置

**如果触发器被禁用**：
- 点击触发器右侧的 **"启用"** 按钮
- 等待 5-10 分钟让触发器生效

### 2. 检查定时触发器配置

在 `cloudfunctions/sendReminder/config.json` 中，确认配置为：

```json
{
  "triggers": [
    {
      "name": "dailyReminder",
      "type": "timer",
      "config": "0 * * * * *"
    }
  ]
}
```

**Cron 表达式说明**：`0 * * * * *`
- 格式：`秒 分 时 日 月 星期 年`
- 含义：每分钟的第 0 秒执行一次
- 例如：20:07:00, 20:08:00, 20:09:00 都会执行

### 3. 检查云函数日志

1. 在云开发控制台 → 云函数 → `sendReminder` → **日志** 标签页
2. 查看是否有 20:07 或 20:08 的执行记录
3. 如果没有执行记录，说明定时触发器没有触发

**查看日志的方法**：
- 选择时间范围：点击 **"当日"** 或选择 **"开始时间"** 和 **"结束时间"**
- 筛选函数：选择 `sendReminder`
- 查看执行记录：应该每分钟都有一次执行

### 4. 手动触发测试

如果定时触发器没有执行，可以手动触发测试：

1. 在云开发控制台 → 云函数 → `sendReminder`
2. 点击 **"测试"** 按钮
3. 输入测试参数：`{}`
4. 点击 **"运行测试"**
5. 查看返回结果和日志

**预期结果**：
- 如果当前时间在 20:07-20:10 之间，应该能匹配到 20:07 的提醒
- 查看日志，确认是否有 `✅ 时间匹配成功` 的日志

### 5. 检查数据库记录

在云开发控制台 → 数据库 → `subscribe_settings` 集合中，确认：

```javascript
{
  enabled: true,  // ✅ 必须为 true
  reminderTimes: [
    {"hour": 20, "minute": 7}  // ✅ 确认时间正确
  ],
  subscribeResult: {
    "YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ": "accept"  // ✅ 必须为 "accept"
  }
}
```

### 6. 重新部署云函数

如果以上检查都正常，但定时触发器仍然不执行，尝试重新部署：

1. 在云开发控制台 → 云函数 → `sendReminder`
2. 点击 **"上传并部署"** 按钮
3. 选择 **"云端安装依赖"**
4. 等待部署完成
5. 等待 5-10 分钟让定时触发器生效

### 7. 检查云函数权限

确认云函数有正确的权限：

1. 在云开发控制台 → 云函数 → `sendReminder` → **权限设置**
2. 确认有 `openapi.subscribeMessage.send` 权限

## 🛠️ 常见问题

### 问题1：定时触发器显示"已禁用"

**解决方法**：
1. 点击触发器右侧的 **"启用"** 按钮
2. 等待 5-10 分钟让触发器生效
3. 如果仍然不工作，重新部署云函数

### 问题2：定时触发器配置错误

**解决方法**：
1. 检查 `config.json` 中的 cron 表达式
2. 确认格式正确：`0 * * * * *`（每分钟执行）
3. 重新部署云函数

### 问题3：云函数执行了但没有匹配到时间

**解决方法**：
1. 查看云函数日志，确认执行时间
2. 检查时间匹配逻辑（允许3分钟误差）
3. 确认数据库中的 `reminderTimes` 格式正确

### 问题4：订阅消息授权过期

**解决方法**：
1. 在小程序中重新打开订阅设置
2. 点击"保存设置"，重新授权订阅消息
3. 确认授权状态为 `"accept"`

## 📝 调试技巧

### 查看实时日志

1. 在云开发控制台 → 云函数 → `sendReminder` → **日志**
2. 选择 **"当日"** 或最近的时间范围
3. 实时查看执行记录

### 手动测试时间匹配

修改云函数代码，临时测试时间匹配：

```javascript
// 临时测试：强制匹配 20:07
const testHour = 20
const testMinute = 7
if (isTimeMatch(currentHour, currentMinute, testHour, testMinute)) {
  console.log('测试：时间匹配成功')
}
```

### 查看定时触发器执行历史

1. 在云开发控制台 → 云函数 → `sendReminder` → **触发器**
2. 查看触发器的执行历史
3. 确认是否有执行记录

## ⚠️ 注意事项

1. **定时触发器延迟**：部署后需要等待 5-10 分钟才能生效
2. **时间匹配误差**：允许3分钟误差，20:08 可以匹配到 20:07
3. **订阅消息授权**：用户授权后只能发送一次，需要重新授权
4. **真机测试**：订阅消息只能在真机上测试，开发者工具无法测试

## 🔗 相关文档

- [云函数定时触发器文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
- [Cron 表达式说明](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html#cron-%E8%A1%A8%E8%BE%BE%E5%BC%8F)
