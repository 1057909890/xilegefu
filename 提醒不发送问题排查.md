# 提醒不发送问题排查指南

## 🔍 快速检查清单

### 1. 检查数据库记录

在云开发控制台 → 数据库 → `subscribe_settings` 集合中，确认你的记录包含以下字段：

```javascript
{
  _id: "...",
  _openid: "你的openid",  // 或 openid 字段
  enabled: true,          // ✅ 必须为 true
  frequency: 3,           // ✅ 提醒频率
  times: ["09:00", "14:00", "18:14"],  // ✅ 提醒时间数组
  reminderTimes: [       // ✅ 提醒时间对象数组
    {"hour": 9, "minute": 0},
    {"hour": 14, "minute": 0},
    {"hour": 18, "minute": 14}
  ],
  type: "daily",          // ✅ 类型
  subscribeResult: {      // ✅ 订阅授权结果（最重要！）
    "YUP2qo8lHFjeWTaJiEuBLSI0W_5zsYzPTEHmZ6tjZAQ": "accept"  // 必须是 "accept"
  }
}
```

**关键检查点**：
- ✅ `enabled` 必须为 `true`
- ✅ `reminderTimes` 数组不能为空
- ✅ `subscribeResult[模板ID]` 必须为 `"accept"`（不是 `"reject"` 或 `"ban"`）

### 2. 检查定时触发器

1. 在云开发控制台 → 云函数 → `sendReminder`
2. 查看 **触发器** 标签页
3. 确认定时触发器状态为 **已启用**
4. 确认触发器配置为：`0 * * * * *`（每分钟触发一次）

**如果触发器未启用**：
- 重新部署云函数
- 等待 5-10 分钟让触发器生效

### 3. 检查云函数日志

1. 在云开发控制台 → 云函数 → `sendReminder` → **日志** 标签页
2. 查看最近的日志，应该能看到类似以下内容：

```
[定时提醒] 当前时间: 18:14, 星期: 0
[定时提醒] 查询到 1 个开启订阅的用户
[定时提醒] 检查用户 oFuYx3ZVdGp9ovs5q2xvvR3Ksg0U, 频率: 3, 类型: daily
[定时提醒] 用户设置的提醒时间: [{"hour":9,"minute":0},{"hour":14,"minute":0},{"hour":18,"minute":14}]
[定时提醒] 比较时间: 当前 18:14 vs 目标 18:14
[定时提醒] ✅ 时间匹配成功: 18:14
[定时提醒] 用户 oFuYx3ZVdGp9ovs5q2xvvR3Ksg0U 的订阅状态: accept
[定时提醒] ✅ 准备发送提醒给用户: oFuYx3ZVdGp9ovs5q2xvvR3Ksg0U
[发送消息] 成功发送给 oFuYx3ZVdGp9ovs5q2xvvR3Ksg0U
[定时提醒] ✅✅✅ 成功发送提醒给用户: ...
```

**常见问题**：

#### 问题1：未授权订阅消息
```
[定时提醒] ⚠️ 用户 xxx 未授权订阅消息, 状态: undefined
```
**解决方法**：
- 在小程序中重新打开订阅设置弹窗
- 点击"保存设置"，重新授权订阅消息
- 确保授权弹窗中选择"允许"

#### 问题2：时间不匹配
```
[定时提醒] 比较时间: 当前 18:15 vs 目标 18:14
```
**解决方法**：
- 检查 `reminderTimes` 中的时间是否正确
- 定时触发器每分钟执行一次，允许2分钟误差
- 如果时间差超过2分钟，不会发送

#### 问题3：没有查询到用户
```
[定时提醒] 查询到 0 个开启订阅的用户
```
**解决方法**：
- 检查数据库中的 `enabled` 字段是否为 `true`
- 检查数据库权限设置

### 4. 手动测试云函数

如果定时触发器没有执行，可以手动触发测试：

1. 在云开发控制台 → 云函数 → `sendReminder`
2. 点击 **测试** 按钮
3. 输入测试参数：`{}`
4. 点击 **运行测试**
5. 查看返回结果和日志

**预期返回**：
```json
{
  "success": true,
  "message": "提醒发送完成",
  "currentTime": "18:14",
  "total": 1,
  "successCount": 1,
  "failCount": 0,
  "matchedUsers": ["你的openid"]
}
```

### 5. 检查订阅消息授权

**重要**：订阅消息授权有时效性！

- 用户授权后，**只能发送一次**（除非用户重新授权）
- 如果已经发送过一次，需要用户重新授权才能再次发送

**检查授权状态**：
1. 查看数据库中的 `subscribeResult` 字段
2. 确认模板ID对应的值为 `"accept"`

**重新授权**：
1. 在小程序中打开订阅设置
2. 点击"保存设置"
3. 重新授权订阅消息

### 6. 检查 miniprogram_state

云函数会先尝试使用 `formal`（正式版），如果失败会尝试 `trial`（体验版）。

**如果收到错误**：
- 检查小程序版本（开发版/体验版/正式版）
- 查看云函数日志中的错误信息

### 7. 常见错误码

| 错误码 | 说明 | 解决方法 |
|--------|------|----------|
| 40037 | 模板ID错误 | 检查模板ID是否正确 |
| 47001 | miniprogram_state 错误 | 检查小程序版本 |
| 43101 | 用户拒绝授权 | 用户需要重新授权 |
| 40001 | 参数错误 | 检查消息数据格式 |

## 🛠️ 调试步骤

### 步骤1：确认数据正确
```javascript
// 在云开发控制台 → 数据库 → subscribe_settings
// 查看你的记录，确认：
// 1. enabled: true
// 2. reminderTimes 数组不为空
// 3. subscribeResult 中有 "accept" 状态
```

### 步骤2：查看云函数日志
```
// 在云开发控制台 → 云函数 → sendReminder → 日志
// 查看是否有执行记录
// 查看是否有错误信息
```

### 步骤3：手动触发测试
```
// 在云开发控制台 → 云函数 → sendReminder → 测试
// 输入: {}
// 运行测试
// 查看返回结果
```

### 步骤4：检查手机通知
```
// 确保：
// 1. 手机微信已登录
// 2. 小程序已授权通知权限
// 3. 手机系统通知权限已开启
```

## 📝 注意事项

1. **订阅消息只能发送一次**：用户授权后，每个模板ID只能发送一次消息，除非用户重新授权
2. **定时触发器延迟**：部署后需要等待 5-10 分钟才能生效
3. **时间匹配误差**：允许2分钟的误差，如果时间差超过2分钟不会发送
4. **真机测试**：订阅消息只能在真机上测试，开发者工具无法测试

## 🔗 相关文档

- [微信小程序订阅消息文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
- [云函数定时触发器文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
